<!-- 차트 데이터 (숨김) -->
<div id="chartDataContainer" data-chart-json="{{ chart_data | tojson | forceescape }}"
    data-birth-date="{{ chart_data.birth_date }}" style="display:none;"></div>

<style>
    .report-container {
        font-family: 'Inter', 'Noto Serif KR', serif;
        color: #2D2D2D;
        line-height: 1.5;
    }

    /* Summary Row */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1px;
        background: #3D3D3D;
        /* Border color */
        border: 1px solid #3D3D3D;
        margin-bottom: 20px;
    }

    .summary-item {
        background: #fff;
        padding: 12px;
    }

    .sm-label {
        font-size: 10px;
        font-weight: 800;
        color: #777;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .sm-value {
        font-size: 13px;
        font-weight: 700;
    }

    /* Element Bar */
    .el-bar-wrap {
        margin-bottom: 25px;
    }

    .el-bar {
        display: flex;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
    }

    .el-segment {
        height: 100%;
        transition: width 0.3s;
    }

    .bg-fire {
        background: #D14124;
    }

    .bg-earth {
        background: #4E6E58;
    }

    .bg-air {
        background: #B29412;
    }

    .bg-water {
        background: #2B5A82;
    }

    /* Data Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    .data-table th {
        text-align: left;
        padding: 8px;
        border-bottom: 2px solid #3D3D3D;
        font-size: 11px;
        color: #777;
        text-transform: uppercase;
    }

    .data-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }

    .data-table tr:hover {
        background: #fbfbfb;
    }

    .tag-el {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 900;
        color: #fff;
        margin-left: 5px;
        text-transform: uppercase;
    }

    .deg-mono {
        font-family: 'Inter', monospace;
        font-weight: 600;
        letter-spacing: -0.2px;
    }

    .save-btn-wrap {
        text-align: right;
        margin-bottom: 15px;
    }
</style>

<div class="report-container">
    <!-- 1. Quick Info Header -->
    <div class="summary-grid">
        <div class="summary-item">
            <div class="sm-label">Sect / Ruler</div>
            <div class="sm-value" id="sectRulerSummary">분석중...</div>
        </div>
        <div class="summary-item">
            <div class="sm-label">Profection</div>
            <div class="sm-value" id="profectionSummary">확인중...</div>
        </div>
        <div class="summary-item">
            <div class="sm-label">Database</div>
            <div class="sm-value" style="font-size:11px;">
                <button hx-post="/htmx/save" hx-include="#chartForm" hx-target="#historyList" hx-swap="innerHTML"
                    style="border:1px solid #3D3D3D; background:none; cursor:pointer; padding:2px 8px; font-weight:700;">기록
                    저장</button>
            </div>
        </div>
    </div>

    <!-- 2. Elemental Balance -->
    <div class="el-bar-wrap">
        <div class="sm-label" style="margin-bottom:8px;">Elemental Distribution</div>
        <div class="el-bar" id="elementDistBar"></div>
    </div>

    <!-- 3. Integrated Position Log -->
    <div class="sm-label" style="margin-bottom:10px;">Planetary & Angular Positions</div>
    <table class="data-table">
        <thead>
            <tr>
                <th style="width:110px;">Point / Planet</th>
                <th>Sign / Element</th>
                <th style="width:90px;">Degree</th>
                <th style="width:40px; text-align:center;">H</th>
            </tr>
        </thead>
        <tbody>
            <!-- Angles -->
            <tr>
                <td style="font-weight:900; color:var(--accent);">ASC (상승궁)</td>
                <td>
                    {{ chart_data.ascendant.sign_ko }}
                    <span class="tag-el bg-{{ chart_data.ascendant.element }}">{{ chart_data.ascendant.element[0]
                        }}</span>
                </td>
                <td class="deg-mono">{{ chart_data.ascendant.degree_formatted }}</td>
                <td style="text-align:center; font-weight:700;">1</td>
            </tr>
            <tr>
                <td style="font-weight:900; color:var(--accent);">MC (중천점)</td>
                <td>
                    {{ chart_data.midheaven.sign_ko }}
                    <span class="tag-el bg-{{ chart_data.midheaven.element }}">{{ chart_data.midheaven.element[0]
                        }}</span>
                </td>
                <td class="deg-mono">{{ chart_data.midheaven.degree_formatted }}</td>
                <td style="text-align:center; font-weight:700;">10</td>
            </tr>
            <!-- Planets -->
            {% for p in chart_data.planets %}
            <tr onmouseenter="highlightPlanet('{{ p.name }}')" onmouseleave="highlightPlanet(null)"
                style="cursor:pointer;">
                <td>
                    <span style="font-size:16px; margin-right:4px;">{{ p.symbol }}</span>
                    <span style="font-weight:700;">{{ p.name_ko }}</span>
                </td>
                <td>
                    {{ p.sign_ko }}
                    <span class="tag-el bg-{{ p.sign_element | default('fire') }}">{{ (p.sign_element or 'F')[0]
                        }}</span>
                </td>
                <td class="deg-mono">{{ p.degree_formatted }}{{ '℞' if p.retrograde else '' }}</td>
                <td style="text-align:center; color:#777; font-weight:700;">{{ p.house }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    if (typeof drawChartFromHtmx === 'function') drawChartFromHtmx();

    (function () {
        const dataStr = document.getElementById('chartDataContainer').dataset.chartJson;
        if (!dataStr) return;
        const data = JSON.parse(dataStr);
        const counts = { fire: 0, earth: 0, air: 0, water: 0 };
        data.planets.forEach(p => {
            const el = p.sign_element || p.element;
            if (counts[el] !== undefined) counts[el]++;
        });
        const total = data.planets.length;
        const bar = document.getElementById('elementDistBar');
        if (bar && total > 0) {
            bar.innerHTML = '';
            ['fire', 'earth', 'air', 'water'].forEach(el => {
                const pc = (counts[el] / total) * 100;
                if (pc > 0) {
                    const seg = document.createElement('div');
                    seg.className = `el-segment bg-${el}`;
                    seg.style.width = pc + '%';
                    seg.title = `${el}: ${Math.round(pc)}%`;
                    bar.appendChild(seg);
                }
            });
        }
    })();
</script>