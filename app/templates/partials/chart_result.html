<div id="chartDataContainer" data-chart-json="{{ chart_data | tojson | forceescape }}"
    data-birth-date="{{ chart_data.birth_date }}" style="display:none;"></div>

<style>
    .report-wrap {
        font-family: 'Inter', 'Noto Serif KR', serif;
        color: #1a1a1a;
        background: #fff;
    }

    .rep-section-title {
        font-size: 11px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: #888;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin: 24px 0 12px 0;
    }

    .metric-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
    }

    .metric-card {
        padding: 16px;
        background: #fcfcfc;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .m-label {
        font-size: 10px;
        font-weight: 800;
        color: #999;
        margin-bottom: 6px;
        display: block;
    }

    .m-value {
        font-size: 14px;
        font-weight: 700;
    }

    /* Simplified Verdict Table */
    .verdict-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

    .verdict-table th {
        text-align: left;
        padding: 12px 8px;
        background: #f9f9f9;
        color: #666;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        border-bottom: 2px solid #1a1a1a;
    }

    .verdict-table td {
        padding: 14px 8px;
        border-bottom: 1px dashed #eee;
        vertical-align: middle;
    }

    .s-symbol {
        font-size: 18px;
        margin-right: 6px;
        vertical-align: middle;
    }

    .s-name {
        font-weight: 800;
        font-size: 13px;
    }

    /* Status Colors */
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 900;
    }

    .st-strong {
        background: #E6F4EA;
        color: #1E7E34;
    }

    .st-weak {
        background: #FCE8E6;
        color: #D93025;
    }

    .st-neutral {
        background: #F1F3F4;
        color: #5F6368;
    }

    .formula-chain {
        font-family: 'Inter', monospace;
        font-size: 10px;
        color: #888;
        letter-spacing: -0.2px;
    }

    .deg-box {
        font-family: 'Inter', monospace;
        font-size: 11px;
        font-weight: 600;
        color: #444;
    }

    .tag-el {
        padding: 2px 5px;
        font-size: 9px;
        font-weight: 900;
        border-radius: 2px;
        color: #fff;
        margin-left: 4px;
    }

    .bg-fire {
        background: #D14124;
    }

    .bg-earth {
        background: #4E6E58;
    }

    .bg-air {
        background: #B29412;
    }

    .bg-water {
        background: #2B5A82;
    }

    .save-btn {
        border: 1px solid #1a1a1a;
        padding: 8px 16px;
        font-weight: 800;
        font-size: 11px;
        cursor: pointer;
        background: none;
        box-shadow: 3px 3px 0px #1a1a1a;
        transition: all 0.1s;
    }

    .save-btn:active {
        transform: translate(1px, 1px);
        box-shadow: 1px 1px 0px #1a1a1a;
    }
</style>

<div class="report-wrap">
    <!-- 1. Technical Context -->
    <div class="rep-section-title">Technical Context</div>
    <div class="metric-grid">
        <div class="metric-card">
            <span class="m-label">운명의 시간 (Sect & Ruler)</span>
            <div class="m-value" id="sectRulerSummary">분석중...</div>
        </div>
        <div class="metric-card">
            <span class="m-label">올해의 영역 (Profection Year)</span>
            <div class="m-value" id="profectionSummary">계산중...</div>
        </div>
    </div>

    <!-- 2. Planetary Verdict (Main) -->
    <div class="rep-section-title">Planetary Condition Verdict</div>
    <table class="verdict-table">
        <thead>
            <tr>
                <th style="width:120px;">Planet</th>
                <th style="width:120px;">Position</th>
                <th style="width:140px;">상태 (Conclusion)</th>
                <th>지배계보 (Audit Chain)</th>
            </tr>
        </thead>
        <tbody>
            {% for p in chart_data.planets %}
            <tr onmouseenter="highlightPlanet('{{ p.name }}')" onmouseleave="highlightPlanet(null)"
                style="cursor:pointer;">
                <td>
                    <span class="s-symbol">{{ p.symbol }}</span>
                    <span class="s-name">{{ p.name_ko }}</span>
                </td>
                <td>
                    <div style="font-weight:700;">{{ p.sign_ko }} <span class="tag-el bg-{{ p.sign_element }}">{{
                            p.sign_element[0]|upper }}</span></div>
                    <div class="deg-box">{{ p.degree_formatted }}{{ '℞' if p.retrograde else '' }} ({{p.house}}H)</div>
                </td>
                <td>
                    {% set st_class = 'st-strong' if '강함' in p.status or '양호' in p.status else ('st-weak' if '약함' in
                    p.status else 'st-neutral') %}
                    <div class="status-badge {{ st_class }}">{{ p.status }}</div>
                </td>
                <td>
                    <div class="formula-chain">{{ p.ruler_chain }}</div>
                    <div style="font-size:9px; color:#bbb; margin-top:2px;">Dom | Tri | Term | Face</div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 3. Lots -->
    <div class="rep-section-title">Fate Points (The Lots)</div>
    <div class="metric-grid">
        <div class="metric-card">
            <span class="m-label">⊗ 행운의 지점 (Lot of Fortune)</span>
            <div class="m-value">{{ chart_data.fortuna.sign_ko }} {{ chart_data.fortuna.degree_formatted }} ({{
                chart_data.fortuna.house }}H)</div>
        </div>
        <div class="metric-card">
            <span class="m-label">◈ 정신의 지점 (Lot of Spirit)</span>
            <div class="m-value">{{ chart_data.spirit.sign_ko }} {{ chart_data.spirit.degree_formatted }} ({{
                chart_data.spirit.house }}H)</div>
        </div>
    </div>

    <!-- 4. Element Balance -->
    <div class="rep-section-title">Elemental Balance</div>
    <div style="margin-bottom: 30px; padding: 0 16px;">
        <div class="el-bar" id="elementDistBar"
            style="display:flex; height:8px; border-radius:4px; overflow:hidden; background:#eee; margin-bottom:8px;">
        </div>
        <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:800;">
            <div style="color:#D14124; display:flex; gap:4px;"><span>FIRE</span> <span id="val-fire"></span></div>
            <div style="color:#4E6E58; display:flex; gap:4px;"><span>EARTH</span> <span id="val-earth"></span></div>
            <div style="color:#A88B12; display:flex; gap:4px;"><span>AIR</span> <span id="val-air"></span></div>
            <div style="color:#2B5A82; display:flex; gap:4px;"><span>WATER</span> <span id="val-water"></span></div>
        </div>
    </div>

    <div style="text-align:right; margin: 30px 0;">
        <button class="save-btn" hx-post="/htmx/save" hx-include="#chartForm" hx-target="#historyList"
            hx-swap="innerHTML">
            데이터 아카이빙 (기록 저장)
        </button>
    </div>
</div>

<script>
    if (typeof drawChartFromHtmx === 'function') drawChartFromHtmx();

    (function () {
        const dataStr = document.getElementById('chartDataContainer').dataset.chartJson;
        const birthDate = document.getElementById('chartDataContainer').dataset.birthDate;
        if (!dataStr) return;
        const data = JSON.parse(dataStr);

        if (typeof calculateProfessionalInsights === 'function') {
            calculateProfessionalInsights(data, birthDate);
        }

        const counts = { fire: 0, earth: 0, air: 0, water: 0 };
        data.planets.forEach(p => {
            const el = p.sign_element;
            if (counts[el] !== undefined) counts[el]++;
        });
        const total = data.planets.length;
        const bar = document.getElementById('elementDistBar');
        if (bar && total > 0) {
            bar.innerHTML = '';
            ['fire', 'earth', 'air', 'water'].forEach(el => {
                const pc = (counts[el] / total) * 100;
                const vEl = document.getElementById(`val-${el}`);
                if (vEl) vEl.innerText = Math.round(pc) + '%';
                if (pc > 0) {
                    const seg = document.createElement('div');
                    seg.className = `bg-${el}`;
                    seg.style.width = pc + '%';
                    bar.appendChild(seg);
                }
            });
        }
    })();
</script>