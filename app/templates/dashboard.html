<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ seo_data.title }}</title>
    <meta name="description" content="{{ seo_data.description }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="/static/js/chart_engine.js"></script>

    <style>
        :root {
            --bg-body: #F9F7F1;
            --bg-panel: #FFFFFF;
            --line-border: #1a1a1a;
            --text-main: #1a1a1a;
            --text-muted: #666;
            --accent: #9A2121;
            --sidebar-width: 400px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Noto Serif KR", serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Left Side: Information & Control */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-right: 2px solid var(--line-border);
            display: flex;
            flex-direction: column;
            z-index: 20;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .sidebar-section {
            padding: 24px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-header {
            background: #1a1a1a;
            color: #fff;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Right Side: The Instrument (Chart) */
        .main-display {
            flex: 1;
            position: relative;
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .chart-paper {
            width: 95%;
            height: 95%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-svg {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        /* Input Controls */
        .input-drawer {
            background: #fdfcf8;
            border: 1px solid #1a1a1a;
            padding: 20px;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            font-size: 11px;
            font-weight: 700;
            color: #555;
            display: block;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            height: 34px;
            padding: 0 8px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
        }

        .form-btn {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        /* Mode Toggle Styled for Top Right of Chart */
        .mode-toggle-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 100;
            background: #fff;
            border: 2px solid #1a1a1a;
            padding: 8px 16px;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 4px 4px 0px #1a1a1a;
            transition: all 0.1s;
        }

        .mode-toggle-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #1a1a1a;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            border-bottom: 2px solid #1a1a1a;
            padding-bottom: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column-reverse;
            }

            .sidebar {
                width: 100%;
                height: 50%;
                border-right: none;
                border-top: 2px solid #1a1a1a;
            }

            .main-display {
                height: 50%;
            }
        }
    </style>
</head>

<body x-data="natalApp()">
    <div class="app-container">
        <!-- Unified Sidebar (Left) -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <span style="font-size:18px; font-weight:800; letter-spacing: -0.5px;">NATALIS ARCHIVE</span>
                <button @click="drawerOpen = !drawerOpen"
                    style="background: #fff; border:none; padding:4px 10px; font-size:11px; font-weight:800; cursor:pointer;">
                    <span x-text="drawerOpen ? 'CLOSE' : 'NEW CHART'"></span>
                </button>
            </header>

            <!-- 1. Input Section -->
            <section class="sidebar-section" x-show="drawerOpen" x-transition>
                <div class="section-title">CHART CONFIGURATION</div>
                <form id="chartForm" hx-post="/htmx/analyze" hx-target="#resultViewContent" hx-swap="innerHTML"
                    @submit="drawerOpen = false">
                    <div class="form-group">
                        <label class="form-label">NAME</label>
                        <input type="text" name="name" class="form-input" required value="{{ input_data.name }}">
                    </div>
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">BIRTH CITY</label>
                        <input type="text" name="place_name" class="form-input" x-model="searchQuery"
                            @input.debounce.300ms="fetchPlaces" placeholder="e.g. Seoul">
                        <div x-show="places.length > 0"
                            style="position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #1a1a1a; z-index:100; max-height:150px; overflow-y:auto;">
                            <template x-for="p in places">
                                <div @click="searchQuery = p.display_name; places = [];"
                                    style="padding:8px; cursor:pointer; font-size:12px; border-bottom:1px solid #eee;"
                                    x-html="p.display_name"></div>
                            </template>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div class="form-group">
                            <label class="form-label">DATE</label>
                            <input type="date" name="birth_date" class="form-input" required
                                value="{{ input_data.birth_date }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">TIME</label>
                            <input type="time" name="birth_time" class="form-input" required
                                value="{{ input_data.birth_time }}">
                        </div>
                    </div>
                    <button type="submit" class="form-btn" style="margin-top:10px;">GENERATE CHART</button>
                </form>
            </section>

            <!-- 2. Active Analysis Results -->
            <section class="sidebar-section" id="resultViewContent">
                {% if chart_data %}
                {% include "partials/chart_result.html" %}
                {% else %}
                <div style="text-align:center; padding:40px 0; color:#aaa; font-style:italic; font-size:13px;">
                    <div style="font-size:32px; margin-bottom:10px; opacity:0.3;">✧</div>
                    분석할 데이터를 입력하거나<br>기록을 선택하세요.
                </div>
                {% endif %}
            </section>

            <!-- 3. Saved Records List -->
            <section class="sidebar-section">
                <div class="section-title">SAVED ARCHIVES</div>
                <div id="historyList">
                    {% include "partials/history_list.html" %}
                </div>
            </section>
        </aside>

        <!-- Main Display (Right) -->
        <main class="main-display">
            <button id="modeBtn" class="mode-toggle-btn" onclick="toggleChartMode()">
                학습 모드 (켜기)
            </button>
            <div class="chart-paper">
                <svg id="chart-svg" width="800" height="800" viewBox="0 0 800 800" class="chart-svg"></svg>
            </div>
            <div
                style="position: absolute; bottom: 20px; right: 24px; font-size: 11px; font-weight:700; color: #1a1a1a; letter-spacing: 1px;">
                TRADITIONAL ASTROLOGY INSTRUMENT v4.7
            </div>
        </main>
    </div>

    <!-- Hidden State -->
    <div id="server-state" data-drawer-open="{{ 'false' if chart_data else 'true' }}"
        data-place-name="{{ input_data.place_name }}" data-birth-date="{{ input_data.birth_date }}"
        style="display:none;"></div>

    <script>
        window.chartEngine = new ChartEngine('chart-svg');

        function natalApp() {
            const stateEl = document.getElementById('server-state');
            return {
                mobileMenuOpen: false,
                drawerOpen: stateEl ? stateEl.dataset.drawerOpen === 'true' : true,
                searchQuery: stateEl ? stateEl.dataset.placeName : '',
                places: [],
                async fetchPlaces() {
                    if (this.searchQuery.length < 2) { this.places = []; return; }
                    try {
                        const res = await fetch(`/api/v1/search-place?query=${encodeURIComponent(this.searchQuery)}`);
                        const data = await res.json();
                        this.places = data.results || [];
                    } catch (e) { this.places = []; }
                }
            }
        }

        function toggleChartMode() {
            if (window.chartEngine) {
                const mode = window.chartEngine.toggleMode();
                const btn = document.getElementById('modeBtn');
                btn.innerText = (mode === 'text') ? "전문가 모드 (복귀)" : "학습 모드 (켜기)";
                btn.style.background = (mode === 'text') ? "#1a1a1a" : "#fff";
                btn.style.color = (mode === 'text') ? "#fff" : "#1a1a1a";
            }
        }

        function drawChartFromHtmx() {
            const dataEl = document.getElementById('chartDataContainer');
            if (dataEl && window.chartEngine) {
                try {
                    const json = JSON.parse(dataEl.dataset.chartJson);
                    window.chartEngine.render(json);
                    const birthDate = dataEl.dataset.birthDate;
                    if (typeof calculateProfessionalInsights === 'function') {
                        calculateProfessionalInsights(json, birthDate);
                    }
                } catch (e) { console.error("Insight Error:", e); }
            }
        }

        function calculateProfessionalInsights(data, birthDate) {
            const sun = data.planets.find(p => p.name === 'Sun');
            const asc = data.ascendant.position;
            const sunRot = (sun.position - asc + 360) % 360;
            const isDay = (sunRot > 180);
            const signRulers = { 'Aries': 'Mars', 'Taurus': 'Venus', 'Gemini': 'Mercury', 'Cancer': 'Moon', 'Leo': 'Sun', 'Virgo': 'Mercury', 'Libra': 'Venus', 'Scorpio': 'Mars', 'Sagittarius': 'Jupiter', 'Capricorn': 'Saturn', 'Aquarius': 'Saturn', 'Pisces': 'Jupiter' };
            const chartRuler = signRulers[data.ascendant.sign] || "Unknown";
            const rulerKo = { 'Sun': '태양', 'Moon': '달', 'Mercury': '수성', 'Venus': '금성', 'Mars': '화성', 'Jupiter': '목성', 'Saturn': '토성' }[chartRuler] || chartRuler;

            const sectEl = document.getElementById('sectRulerSummary');
            if (sectEl) sectEl.innerText = `${isDay ? '낮(Day)' : '밤(Night)'} • 지배성: ${rulerKo}`;

            const profEl = document.getElementById('profectionSummary');
            if (profEl && birthDate) {
                const bDate = new Date(birthDate);
                const age = new Date().getFullYear() - bDate.getFullYear();
                const profHouse = (age % 12) + 1;
                const houseKeywords = ["자아/생명", "소유/가치", "소통/학습", "가정/뿌리", "유희/자녀", "헌신/건강", "관계/결혼", "변화/공유", "철학/확장", "사회/천직", "공동체/미래", "성찰/무의식"];
                profEl.innerText = `만 ${age}세 • ${profHouse}하우스 진입`;
            }
        }

        function highlightPlanet(name) {
            if (window.chartEngine && typeof window.chartEngine.highlight === 'function') {
                window.chartEngine.highlight(name);
            }
        }

        document.addEventListener("DOMContentLoaded", () => { drawChartFromHtmx(); });
    </script>
</body>

</html>