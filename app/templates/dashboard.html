<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ seo_data.title }}</title>
    <meta name="description" content="{{ seo_data.description }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="/static/js/chart_engine.js"></script>

    <style>
        :root {
            --bg-body: #EBE8E0;
            /* Darker workstation surface */
            --bg-sidebar: #FCFAF5;
            /* Premium parchment sidebar */
            --line-border: #3D3D3D;
            --text-main: #2D2D2D;
            --text-muted: #777;
            --accent: #9A2121;
            --sidebar-width: 400px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            font-family: 'Noto Serif KR', serif;
        }

        .dashboard-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Sidebar Section */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 2px solid var(--line-border);
            display: flex;
            flex-direction: column;
            z-index: 20;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            background: var(--bg-sidebar);
            color: var(--text-main);
            padding: 24px;
            font-size: 16px;
            font-weight: 900;
            letter-spacing: 1px;
            text-align: center;
            border-bottom: 2px solid var(--line-border);
            text-transform: uppercase;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--line-border);
            background: rgba(0, 0, 0, 0.03);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 800;
            color: #888;
            letter-spacing: 1px;
            transition: all 0.2s;
            border-right: 1px solid #ddd;
        }

        .tab-btn.active {
            background: var(--bg-sidebar);
            color: var(--accent);
            font-weight: 900;
            border-bottom: 2px solid var(--bg-sidebar);
            margin-bottom: -2px;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-content-area {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .tab-section {
            padding: 24px;
        }

        /* Main Display Section */
        .main-display {
            flex: 1;
            position: relative;
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* Vignette effect */
            background-image: radial-gradient(circle at center, rgba(255, 255, 255, 0.2) 0%, rgba(0, 0, 0, 0.05) 100%);
        }

        .chart-paper {
            width: 95%;
            height: auto;
            max-width: 950px;
            aspect-ratio: 1/1;
            background: #F9F7F1;
            box-shadow:
                0 25px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .mode-toggle-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 100;
            background: #fff;
            border: 2px solid #1a1a1a;
            padding: 8px 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 4px 4px 0px #1a1a1a;
            transition: all 0.1s;
        }

        .mode-toggle-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #1a1a1a;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-size: 10px;
            font-weight: 800;
            color: #555;
            display: block;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .form-input {
            width: 100%;
            height: 38px;
            padding: 0 10px;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            border-radius: 0;
        }

        .form-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            margin-top: 10px;
            box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }

        .form-btn:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            font-size: 14px;
            font-weight: 800;
            border-bottom: 2px solid #1a1a1a;
            padding-bottom: 6px;
            margin-bottom: 18px;
        }

        @media (max-width: 1024px) {
            .dashboard-container {
                flex-direction: column-reverse;
            }

            .sidebar {
                width: 100%;
                height: 50%;
                border-right: none;
                border-top: 2px solid #1a1a1a;
            }
        }
    </style>
</head>

<body x-data="natalApp()">
    <div class="dashboard-container">
        <!-- Sidebar with Tabs (Left) -->
        <aside class="sidebar">
            <header class="sidebar-header">점성술 데이터베이스</header>

            <nav class="tab-nav">
                <button class="tab-btn" :class="{ 'active': activeTab === 'config' }"
                    @click="activeTab = 'config'">설정</button>
                <button class="tab-btn" :class="{ 'active': activeTab === 'report' }"
                    @click="activeTab = 'report'">결과</button>
                <button class="tab-btn" :class="{ 'active': activeTab === 'archive' }"
                    @click="activeTab = 'archive'">기록</button>
            </nav>

            <div class="tab-content-area">
                <!-- Tab 1: Config (Input) -->
                <div x-show="activeTab === 'config'" class="tab-section">
                    <div class="section-header">새 차트 생성</div>
                    <form id="chartForm" hx-post="/htmx/analyze" hx-target="#resultViewContent" hx-swap="innerHTML"
                        @submit="if(!validateForm()) { $event.preventDefault(); return; } activeTab = 'report'">
                        <div class="form-group">
                            <label class="form-label">이름</label>
                            <input type="text" name="name" class="form-input" required value="{{ input_data.name }}">
                        </div>
                        <div class="form-group" style="position:relative;">
                            <label class="form-label">출생 도시 (검색 후 선택 필순)</label>
                            <input type="text" name="place_name" class="form-input" x-model="searchQuery"
                                @input.debounce.300ms="fetchPlaces" placeholder="도시명 검색..." required autocomplete="off">
                            <div x-show="places.length > 0"
                                style="position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #1a1a1a; z-index:100; max-height:200px; overflow-y:auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <template x-for="p in places">
                                    <div @click="selectPlace(p)"
                                        style="padding:10px; cursor:pointer; font-size:12px; border-bottom:1px solid #eee;"
                                        x-html="p.display_name"></div>
                                </template>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <div class="form-group">
                                <label class="form-label">생년월일 (8자리: YYYYMMDD)</label>
                                <input type="text" name="birth_date" class="form-input" required maxlength="8"
                                    placeholder="19901025"
                                    value="{{ input_data.birth_date|replace('-','') if input_data.birth_date else '' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">출생 시간 (4자리: HHMM)</label>
                                <input type="text" name="birth_time" class="form-input" required maxlength="4"
                                    placeholder="1430"
                                    value="{{ input_data.birth_time|replace(':','') if input_data.birth_time else '' }}">
                            </div>
                        </div>
                        <button type="submit" class="form-btn">차트 생성 및 분석</button>
                    </form>
                </div>

                <!-- Tab 2: Report (Results) -->
                <div x-show="activeTab === 'report'" class="tab-section" id="resultViewContent">
                    {% if chart_data %}
                    {% include "partials/chart_result.html" %}
                    {% else %}
                    <div style="text-align:center; padding:100px 0; color:#aaa;">
                        <div style="font-size:40px; margin-bottom:15px; opacity:0.3;">✧</div>
                        <p style="font-size:13px; font-style:italic;">데이터를 입력하거나<br>아카이브에서 기록을 불러오세요.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Tab 3: Archive (History) -->
                <div x-show="activeTab === 'archive'" class="tab-section">
                    <div class="section-header">저장된 기록 아카이브</div>
                    <div id="historyList">
                        {% include "partials/history_list.html" %}
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Display -->
        <main class="main-display">
            <button id="modeBtn" class="mode-toggle-btn" onclick="toggleChartMode()">학습 모드 (켜기)</button>
            <div class="chart-paper">
                <svg id="chart-svg" width="800" height="800" viewBox="0 0 800 800" class="chart-svg"></svg>
            </div>
            <div
                style="position: absolute; bottom: 20px; right: 24px; font-size: 11px; font-weight:700; color: #1a1a1a; letter-spacing: 1.5px; opacity: 0.6;">
                TRADITIONAL ASTROLOGY INSTRUMENT v4.7
            </div>
        </main>
    </div>

    <!-- Hidden State -->
    <div id="server-state" data-active-tab="{{ 'report' if chart_data else 'config' }}"
        data-place-name="{{ input_data.place_name }}" data-birth-date="{{ input_data.birth_date }}"
        style="display:none;"></div>

    <script>
        window.chartEngine = new ChartEngine('chart-svg');

        function natalApp() {
            const stateEl = document.getElementById('server-state');
            return {
                activeTab: stateEl ? stateEl.dataset.activeTab : 'config',
                searchQuery: stateEl ? stateEl.dataset.placeName : '',
                lastSelectedPlace: stateEl ? stateEl.dataset.placeName : '',
                places: [],
                async fetchPlaces() {
                    if (this.searchQuery.length < 2) { this.places = []; return; }
                    try {
                        const res = await fetch(`/api/v1/search-place?query=${encodeURIComponent(this.searchQuery)}`);
                        const data = await res.json();
                        this.places = data.results || [];
                    } catch (e) { this.places = []; }
                },
                selectPlace(p) {
                    this.searchQuery = p.display_name;
                    this.lastSelectedPlace = p.display_name;
                    this.places = [];
                },
                validateForm() {
                    if (!this.lastSelectedPlace || this.searchQuery !== this.lastSelectedPlace) {
                        alert("도시 목록에서 유효한 장소를 선택해주세요.");
                        return false;
                    }
                    const dateStr = document.getElementsByName('birth_date')[0].value;
                    const timeStr = document.getElementsByName('birth_time')[0].value;

                    // Date Validation
                    if (dateStr.length !== 8 || isNaN(dateStr)) {
                        alert("날짜는 8자리 숫자로 입력해주세요 (YYYYMMDD).");
                        return false;
                    }
                    const y = parseInt(dateStr.substring(0, 4));
                    const m = parseInt(dateStr.substring(4, 6));
                    const d = parseInt(dateStr.substring(6, 8));
                    if (y < 1000 || y > 2100) { alert("연도가 범위를 벗어났습니다 (1000-2100)."); return false; }
                    if (m < 1 || m > 12) { alert("월이 잘못되었습니다 (01-12)."); return false; }
                    if (d < 1 || d > 31) { alert("일이 잘못되었습니다 (01-31)."); return false; }

                    // Time Validation
                    if (timeStr.length !== 4 || isNaN(timeStr)) {
                        alert("시간은 4자리 숫자로 입력해주세요 (HHMM).");
                        return false;
                    }
                    const hh = parseInt(timeStr.substring(0, 2));
                    const mm = parseInt(timeStr.substring(2, 4));
                    if (hh < 0 || hh > 23) { alert("시간(시)이 잘못되었습니다 (00-23)."); return false; }
                    if (mm < 0 || mm > 59) { alert("시간(분)이 잘못되었습니다 (00-59)."); return false; }

                    return true;
                }
            }
        }

        function toggleChartMode() {
            if (window.chartEngine) {
                const mode = window.chartEngine.toggleMode();
                const btn = document.getElementById('modeBtn');
                btn.innerText = (mode === 'text') ? "전문가 모드 (복귀)" : "학습 모드 (켜기)";
                btn.style.background = (mode === 'text') ? "#1a1a1a" : "#fff";
                btn.style.color = (mode === 'text') ? "#fff" : "#1a1a1a";
            }
        }

        function drawChartFromHtmx() {
            const dataEl = document.getElementById('chartDataContainer');
            if (dataEl && window.chartEngine) {
                try {
                    const json = JSON.parse(dataEl.dataset.chartJson);
                    window.chartEngine.render(json);
                    const birthDate = dataEl.dataset.birthDate;
                    if (typeof calculateProfessionalInsights === 'function') {
                        calculateProfessionalInsights(json, birthDate);
                    }
                } catch (e) { console.error("Insight Error:", e); }
            }
        }

        function calculateProfessionalInsights(data, birthDate) {
            const sun = data.planets.find(p => p.name === 'Sun');
            const asc = data.ascendant.position;
            const sunRot = (sun.position - asc + 360) % 360;
            const isDay = (sunRot > 180);
            const signRulers = { 'Aries': 'Mars', 'Taurus': 'Venus', 'Gemini': 'Mercury', 'Cancer': 'Moon', 'Leo': 'Sun', 'Virgo': 'Mercury', 'Libra': 'Venus', 'Scorpio': 'Mars', 'Sagittarius': 'Jupiter', 'Capricorn': 'Saturn', 'Aquarius': 'Saturn', 'Pisces': 'Jupiter' };
            const chartRuler = signRulers[data.ascendant.sign] || "Unknown";
            const rulerKo = { 'Sun': '태양', 'Moon': '달', 'Mercury': '수성', 'Venus': '금성', 'Mars': '화성', 'Jupiter': '목성', 'Saturn': '토성' }[chartRuler] || chartRuler;

            const sectEl = document.getElementById('sectRulerSummary');
            if (sectEl) sectEl.innerText = `${isDay ? '낮(Day)' : '밤(Night)'} • 지배성: ${rulerKo}`;

            const profEl = document.getElementById('profectionSummary');
            if (profEl && birthDate) {
                const bDate = new Date(birthDate);
                const age = new Date().getFullYear() - bDate.getFullYear();
                const profHouse = (age % 12) + 1;
                const houseKeywords = ["신체/성격/외형", "재산/소유/생계", "형제/소통/이웃", "가정/가족/기초", "자녀/즐거움/창의", "질병/고난/일", "결혼/파트너/계약", "죽음/유산/숨겨진 것", "철학/종교/여행", "경력/명성/권위", "친구/도움/획득", "적/고통/은둔"];
                profEl.innerText = `만 ${age}세 • ${profHouse}하우스 (${houseKeywords[profHouse - 1]})`;
            }
        }

        function highlightPlanet(name) {
            if (window.chartEngine && typeof window.chartEngine.highlight === 'function') {
                window.chartEngine.highlight(name);
            }
        }

        document.addEventListener("DOMContentLoaded", () => { drawChartFromHtmx(); });
    </script>
</body>

</html>