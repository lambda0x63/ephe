<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東方天宮圖 : Oriental Astrolab</title>
    <!-- 폰트 및 스타일은 기존과 동일 -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&family=Noto+Sans+KR:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* ... 이전 스타일 그대로 유지 ... */
        :root {
            --bg-app: #e0e0e0;
            --sidebar-width: 280px;
            --border-color: #1a1a1a;
            --terminal-bg: #fff;
            --accent: #222;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        aside {
            width: var(--sidebar-width);
            background: #151515;
            color: #ccc;
            display: flex;
            flex-direction: column;
            border-right: 4px solid var(--border-color);
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 30px 24px;
            border-bottom: 1px solid #333;
            background: #111;
        }

        .brand-title {
            font-family: 'Noto Serif KR', serif;
            font-weight: 900;
            font-size: 24px;
            color: #fff;
        }

        .brand-sub {
            font-family: 'Roboto Mono', monospace;
            font-size: 10px;
            color: #666;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        .controls-area {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-label {
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            color: #888;
            font-weight: 700;
        }

        .input-field {
            background: #222;
            border: 1px solid #444;
            height: 40px;
            padding: 0 12px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #fff;
            outline: none;
            width: 100%;
            border-radius: 4px;
        }

        .input-field:focus {
            border-color: #fff;
            background: #333;
        }

        .btn-analyze {
            margin-top: 10px;
            height: 48px;
            background: #e0e0e0;
            color: #000;
            border: none;
            font-family: 'Noto Serif KR', serif;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #000;
            border-radius: 4px;
        }

        .btn-analyze:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #000;
        }

        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }

        .chart-section {
            flex: 1;
            background: #e5e5e5;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        .chart-section:active {
            cursor: grabbing;
        }

        .chart-bg-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        .svg-container {
            width: 100%;
            height: 100%;
            display: block;
            transform-origin: 0 0;
            will-change: transform;
        }

        svg {
            overflow: visible;
        }

        .reset-btn {
            position: absolute;
            bottom: 60px;
            right: 20px;
            background: #fff;
            border: 2px solid #000;
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 900;
            font-family: 'Roboto Mono';
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
            z-index: 50;
        }

        .reset-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
        }

        .data-terminal {
            height: 40px;
            background: var(--terminal-bg);
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-top: 4px solid var(--border-color);
            transition: height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 60;
        }

        .data-terminal.expanded {
            height: 380px;
        }

        .panel-handle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Roboto Mono';
            font-weight: 700;
            font-size: 12px;
            color: #333;
            transition: background 0.2s;
        }

        .panel-handle:hover {
            background: #e0e0e0;
        }

        .data-col {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            padding-top: 40px;
        }

        .data-terminal.expanded .data-col {
            opacity: 1;
            pointer-events: auto;
        }

        .data-col:last-child {
            border-right: none;
        }

        .terminal-header {
            background: #111;
            color: #fff;
            padding: 8px 20px;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9f9f9;
            border-bottom: 1px solid #ddd;
            text-align: left;
            padding: 10px 16px;
            font-size: 11px;
            color: #888;
            position: sticky;
            top: 0;
            z-index: 4;
        }

        td {
            border-bottom: 1px solid #eee;
            padding: 10px 16px;
            vertical-align: middle;
        }

        tr:hover {
            background: #f0f0f0;
        }

        tr.active-row {
            background: #222 !important;
            color: #fff;
        }

        tr.active-row .t-kor-main,
        tr.active-row .t-mono {
            color: #fff;
        }

        tr.active-row .p-icon-sm {
            background: #000;
            border-color: #fff;
            color: #fff;
        }

        .cell-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .t-kor-main {
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 700;
            font-size: 14px;
            color: #222;
        }

        .t-mono {
            font-family: 'Roboto Mono';
            font-size: 13px;
            color: #444;
            font-weight: 500;
        }

        .p-icon-sm {
            width: 26px;
            height: 26px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: "Segoe UI Symbol";
            font-size: 15px;
            border-radius: 4px;
            background: #fff;
            flex-shrink: 0;
            color: #000;
        }

        .asp-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 24px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .asp-item:hover {
            background: #fafafa;
        }

        .asp-obj {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 140px;
            font-weight: 700;
            font-size: 14px;
            color: #222;
        }

        .asp-obj.right {
            justify-content: flex-end;
            text-align: right;
        }

        .inline-symbol {
            font-family: "Segoe UI Symbol";
            font-size: 16px;
            font-weight: normal;
        }

        .asp-tag {
            padding: 4px 10px;
            background: #f4f4f4;
            border: 1px solid #ddd;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Roboto Mono';
            border-radius: 4px;
        }

        .asp-hard {
            background: #222;
            color: #fff;
            border-color: #000;
        }

        .planet-group {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .planet-group:hover circle {
            fill: #eee;
            stroke: #b71c1c;
            stroke-width: 2px;
        }

        .planet-group.active circle {
            fill: #222;
            stroke: #b71c1c;
            stroke-width: 3px;
        }

        .planet-group.active text {
            fill: #fff;
        }

        .planet-glyph {
            font-size: 18px;
            fill: #000;
            font-weight: bold;
            font-family: "Segoe UI Symbol";
            dominant-baseline: central;
            text-anchor: middle;
        }

        .tooltip {
            position: absolute;
            padding: 6px 10px;
            background: #000;
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 1000;
            font-family: 'Noto Sans KR';
        }

        text {
            font-family: 'Noto Sans KR', sans-serif;
            pointer-events: none;
        }

        .sign-glyph {
            font-size: 24px;
            fill: #000;
            font-family: "Segoe UI Symbol";
        }

        .planet-node-bg {
            fill: #ffffff;
            stroke: #000000;
            stroke-width: 1.5px;
        }

        .data-col::-webkit-scrollbar {
            width: 6px;
        }

        .data-col::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
    </style>
</head>

<body>

    <div id="tooltip" class="tooltip"></div>

    <aside>
        <div class="sidebar-header">
            <div class="brand-title">東方天宮圖</div>
            <div class="brand-sub">ORIENTAL ASTROLAB</div>
        </div>
        <form id="input-form" class="controls-area">
            <div class="input-group">
                <span class="input-label">DATE</span>
                <input type="date" id="birth_date" value="1999-01-10" class="input-field">
            </div>
            <div class="input-group">
                <span class="input-label">TIME</span>
                <input type="time" id="birth_time" value="00:31" class="input-field">
            </div>
            <div class="input-group">
                <span class="input-label">LOCATION</span>
                <input type="text" id="place_name" value="Daegu" placeholder="CITY NAME" class="input-field"
                    style="text-transform:uppercase;">
            </div>
            <button type="submit" class="btn-analyze">分析 (ANALYZE)</button>
        </form>
    </aside>

    <div class="main-wrapper">
        <section class="chart-section" id="chart-section">
            <div class="chart-bg-pattern"></div>
            <button class="reset-btn" id="reset-view">⟲ RESET VIEW</button>
            <div class="svg-container" id="svg-container">
                <svg id="chart-svg" width="600" height="600" viewBox="0 0 600 600"></svg>
            </div>
        </section>

        <section class="data-terminal" id="data-panel">
            <div class="panel-handle" id="panel-toggle">
                <span id="toggle-icon">▲ OPEN DATA PANEL</span>
            </div>
            <div class="data-col">
                <div class="terminal-header">PLANET (행성)</div>
                <table id="planet-table">
                    <tbody id="planet-tbody">
                        <tr>
                            <td colspan="4" style="text-align:center; padding:30px; color:#999;">Waiting...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="data-col">
                <div class="terminal-header">ASPECTS (각도)</div>
                <div id="aspect-list" style="padding-bottom:20px;">
                    <div style="text-align:center; padding:30px; color:#999;">Waiting...</div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const CONFIG = { signs: ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces'], signSymbols: ['♈\uFE0E', '♉\uFE0E', '♊\uFE0E', '♋\uFE0E', '♌\uFE0E', '♍\uFE0E', '♎\uFE0E', '♏\uFE0E', '♐\uFE0E', '♑\uFE0E', '♒\uFE0E', '♓\uFE0E'], radius: { outer: 260, sign: 220, house: 180, inner: 110, planet_base: 150, planet_step: 24 } };

        class ChartEngine {
            constructor(svgId) { this.svg = document.getElementById(svgId); this.center = { x: 300, y: 300 }; }
            clear() { this.svg.innerHTML = ''; }
            getSvgPos(radius, zodiacDegree, ascDegree) { const angleDeg = 180 - (zodiacDegree - ascDegree); const rad = angleDeg * (Math.PI / 180); return { x: this.center.x + radius * Math.cos(rad), y: this.center.y + radius * Math.sin(rad) }; }
            createLine(x1, y1, x2, y2, color, width, dash = '') { return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="${width}" stroke-dasharray="${dash}" stroke-linecap="square" />`; }
            createText(x, y, text, size, color, anchor = "middle", weight = "normal", className = "") { return `<text x="${x}" y="${y}" font-size="${size}" fill="${color}" text-anchor="${anchor}" dominant-baseline="central" font-weight="${weight}" class="${className}">${text}</text>`; }
            createArcPath(r1, r2, startDeg, endDeg, ascDeg) { const startAngle = (180 - (startDeg - ascDeg)) * (Math.PI / 180); const endAngle = (180 - (endDeg - ascDeg)) * (Math.PI / 180); const x1_o = this.center.x + r1 * Math.cos(startAngle); const y1_o = this.center.y + r1 * Math.sin(startAngle); const x2_o = this.center.x + r1 * Math.cos(endAngle); const y2_o = this.center.y + r1 * Math.sin(endAngle); const x1_i = this.center.x + r2 * Math.cos(startAngle); const y1_i = this.center.y + r2 * Math.sin(startAngle); const x2_i = this.center.x + r2 * Math.cos(endAngle); const y2_i = this.center.y + r2 * Math.sin(endAngle); return `M ${x1_o} ${y1_o} A ${r1} ${r1} 0 0 0 ${x2_o} ${y2_o} L ${x2_i} ${y2_i} A ${r2} ${r2} 0 0 1 ${x1_i} ${y1_i} Z`; }
            resolveCollisions(planets) { const sorted = [...planets].filter(p => p.name !== 'Ascendant').sort((a, b) => a.position - b.position); sorted.forEach((p, i) => { p.track = 0; if (i > 0) { const prev = sorted[i - 1]; if (Math.abs(p.position - prev.position) < 9) { if (prev.track === 0) p.track = 1; else if (prev.track === 1) p.track = 2; else p.track = 0; } } }); return sorted; }

            render(data) {
                this.clear();
                let svgContent = '';
                const ascAbs = data.planets.find(p => p.name === 'Ascendant')?.position || (CONFIG.signs.indexOf(data.ascendant.sign) * 30 + data.ascendant.degree);
                svgContent += `<circle cx="${this.center.x}" cy="${this.center.y}" r="${CONFIG.radius.outer}" fill="#fff" stroke="#000" stroke-width="3"/>`;
                svgContent += `<circle cx="${this.center.x}" cy="${this.center.y}" r="${CONFIG.radius.inner}" fill="none" stroke="#999" stroke-width="1"/>`;
                for (let i = 0; i < 12; i++) {
                    const startZ = i * 30; const endZ = (i + 1) * 30; svgContent += `<path d="${this.createArcPath(CONFIG.radius.outer, CONFIG.radius.sign, startZ, endZ, ascAbs)}" fill="none" stroke="#000" stroke-width="1" />`;
                    const pos = this.getSvgPos((CONFIG.radius.outer + CONFIG.radius.sign) / 2, startZ + 15, ascAbs); svgContent += this.createText(pos.x, pos.y, CONFIG.signSymbols[i], 24, "#000", "middle", "normal", "sign-glyph");
                    for (let d = 2; d < 30; d += 2) { const isTen = d % 10 === 0; const len = isTen ? 7 : 3; const t1 = this.getSvgPos(CONFIG.radius.sign, startZ + d, ascAbs); const t2 = this.getSvgPos(CONFIG.radius.sign - len, startZ + d, ascAbs); svgContent += this.createLine(t1.x, t1.y, t2.x, t2.y, "#000", isTen ? 1.2 : 0.5); }
                }
                data.houses.forEach((h) => { const signIdx = CONFIG.signs.indexOf(h.sign); const cuspZ = signIdx * 30 + h.degree; const p1 = this.getSvgPos(CONFIG.radius.inner, cuspZ, ascAbs); const p2 = this.getSvgPos(CONFIG.radius.sign, cuspZ, ascAbs); const isAngle = [1, 4, 7, 10].includes(h.number); svgContent += this.createLine(p1.x, p1.y, p2.x, p2.y, isAngle ? "#000" : "#999", isAngle ? 2 : 1); const numPos = this.getSvgPos(CONFIG.radius.house, cuspZ + 15, ascAbs); svgContent += this.createText(numPos.x, numPos.y, h.number, 12, "#555", "middle", "bold"); });
                data.aspects.forEach(asp => { const p1 = data.planets.find(p => p.name === asp.planet1); const p2 = data.planets.find(p => p.name === asp.planet2); if (p1 && p2 && asp.orb < 6) { const xy1 = this.getSvgPos(CONFIG.radius.inner, p1.position, ascAbs); const xy2 = this.getSvgPos(CONFIG.radius.inner, p2.position, ascAbs); let color = "#bbb"; let width = 1; if (["Square", "Opposition"].includes(asp.type)) { color = "#000"; width = 1.8; } svgContent += this.createLine(xy1.x, xy1.y, xy2.x, xy2.y, color, width); } });
                this.svg.innerHTML = svgContent;
                const visiblePlanets = this.resolveCollisions(data.planets);
                visiblePlanets.forEach(p => { let r = CONFIG.radius.planet_base; if (p.track === 1) r -= CONFIG.radius.planet_step; else if (p.track === 2) r += CONFIG.radius.planet_step; const xy = this.getSvgPos(r, p.position, ascAbs); const realPos = this.getSvgPos(CONFIG.radius.sign - 3, p.position, ascAbs); const g = document.createElementNS("http://www.w3.org/2000/svg", "g"); g.setAttribute("class", "planet-group"); g.setAttribute("data-name", p.name); g.innerHTML += this.createLine(xy.x, xy.y, realPos.x, realPos.y, "#999", 1); g.innerHTML += `<circle cx="${xy.x}" cy="${xy.y}" r="16" class="planet-node-bg" />`; g.innerHTML += this.createText(xy.x, xy.y, p.symbol, 18, "#000", "middle", "normal", "planet-glyph"); if (p.retrograde) g.innerHTML += this.createText(xy.x + 11, xy.y - 9, "R", 10, "#b71c1c", "start", "bold"); g.addEventListener('mouseenter', (e) => showTooltip(e, `${p.symbol} ${p.name_ko} (${p.sign_ko})`)); g.addEventListener('mouseleave', hideTooltip); g.addEventListener('click', () => highlightPlanet(p.name)); this.svg.appendChild(g); });
            }
        }
        const engine = new ChartEngine('chart-svg');

        // --- INTERACTION ---
        const chartSection = document.getElementById('chart-section');
        const svgContainer = document.getElementById('svg-container');
        let state = { scale: 1, x: 0, y: 0 };
        const ZOOM_SENSITIVITY = 0.0015;

        function centerChart() {
            const rect = chartSection.getBoundingClientRect();
            state.x = (rect.width - 600) / 2;
            state.y = (rect.height - 600) / 2;
            state.scale = 1;
            updateTransform();
        }
        window.addEventListener('resize', centerChart);
        centerChart(); // 초기 중앙 정렬

        chartSection.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = chartSection.getBoundingClientRect();
            const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
            const worldX = (mouseX - state.x) / state.scale; const worldY = (mouseY - state.y) / state.scale;
            const delta = -e.deltaY * ZOOM_SENSITIVITY;
            const newScale = Math.min(Math.max(state.scale * Math.exp(delta), 0.2), 5.0);
            state.x = mouseX - worldX * newScale; state.y = mouseY - worldY * newScale; state.scale = newScale;
            updateTransform();
        });

        let isDragging = false; let startX, startY;
        chartSection.addEventListener('mousedown', (e) => { isDragging = true; startX = e.clientX; startY = e.clientY; chartSection.style.cursor = 'grabbing'; });
        window.addEventListener('mousemove', (e) => { if (!isDragging) return; e.preventDefault(); const dx = e.clientX - startX; const dy = e.clientY - startY; state.x += dx; state.y += dy; startX = e.clientX; startY = e.clientY; updateTransform(); });
        window.addEventListener('mouseup', () => { isDragging = false; chartSection.style.cursor = 'grab'; });

        function updateTransform() { svgContainer.style.transform = `translate3d(${state.x}px, ${state.y}px, 0) scale(${state.scale})`; }
        document.getElementById('reset-view').addEventListener('click', centerChart);

        const panel = document.getElementById('data-panel');
        const toggleBtn = document.getElementById('panel-toggle');
        const toggleIcon = document.getElementById('toggle-icon');
        let isExpanded = false;
        toggleBtn.addEventListener('click', () => { isExpanded = !isExpanded; if (isExpanded) { panel.classList.add('expanded'); toggleIcon.innerText = "▼ CLOSE DATA PANEL"; } else { panel.classList.remove('expanded'); toggleIcon.innerText = "▲ OPEN DATA PANEL"; } });

        const tooltip = document.getElementById('tooltip');
        function showTooltip(e, text) { tooltip.innerText = text; tooltip.style.opacity = 1; tooltip.style.left = e.clientX + 'px'; tooltip.style.top = e.clientY - 10 + 'px'; }
        function hideTooltip() { tooltip.style.opacity = 0; }

        // [중요] 자동 핏 제거, 하이라이트만 유지
        function highlightPlanet(planetName) {
            // Chart Highlight
            document.querySelectorAll('.planet-group').forEach(el => el.classList.remove('active'));
            const group = document.querySelector(`.planet-group[data-name="${planetName}"]`);
            if (group) group.classList.add('active');

            // Table Highlight
            document.querySelectorAll('.active-row').forEach(el => el.classList.remove('active-row'));
            const row = document.getElementById(`row-${planetName}`);
            if (row) {
                row.classList.add('active-row');
                // 패널이 열려 있을 때만 스크롤
                if (isExpanded) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 리스트 클릭 이벤트 (이제 차트 리셋을 하지 않음)
        function onListClick(planetName) {
            highlightPlanet(planetName);
        }

        document.getElementById('input-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const inputPlace = document.getElementById('place_name').value || "UNKNOWN";
            btn.textContent = "Analyzing..."; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/v1/natal-chart`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ birth_date: document.getElementById('birth_date').value, birth_time: document.getElementById('birth_time').value + ":00", place_name: inputPlace }) });
                if (!res.ok) throw new Error("Server Error");
                const data = await res.json();

                centerChart(); // 초기 로드 시에는 리셋 (당연함)
                engine.render(data);

                const getSymbol = (name) => { const p = data.planets.find(pl => pl.name === name); return p ? p.symbol : ''; };
                const tbody = document.getElementById('planet-tbody'); tbody.innerHTML = '';
                const ascSignIdx = CONFIG.signs.indexOf(data.ascendant.sign);
                tbody.innerHTML += `<tr><td><div class="cell-group"><span class="t-kor-main">상승궁 (Asc)</span></div></td><td><div class="cell-group"><div class="p-icon-sm">${CONFIG.signSymbols[ascSignIdx]}</div><div class="t-kor-main">${data.ascendant.sign_ko}</div></div></td><td class="t-mono">${data.ascendant.degree_formatted}</td><td class="t-mono">1</td></tr>`;

                data.planets.forEach(p => {
                    const signIdx = CONFIG.signs.indexOf(p.sign);
                    // onclick -> highlightPlanet만 호출
                    tbody.innerHTML += `<tr id="row-${p.name}" onclick="onListClick('${p.name}')"><td><div class="cell-group"><div class="p-icon-sm" style="border-radius:50%;">${p.symbol}</div><div class="t-kor-main">${p.name_ko}</div></div></td><td><div class="cell-group"><div class="p-icon-sm" style="border:none;">${CONFIG.signSymbols[signIdx]}</div><div class="t-kor-main">${p.sign_ko}</div></div></td><td class="t-mono">${p.degree_formatted} ${p.retrograde ? '<span style="color:#b71c1c; font-weight:900;">R</span>' : ''}</td><td class="t-mono">${p.house}</td></tr>`;
                });

                const aspectList = document.getElementById('aspect-list'); const majors = data.aspects.filter(a => a.orb < 6);
                if (majors.length === 0) aspectList.innerHTML = "<div style='padding:30px; text-align:center; color:#999;'>No Major Aspects</div>";
                else {
                    aspectList.innerHTML = majors.map(a => {
                        let tagClass = ''; if (["Square", "Opposition"].includes(a.type)) tagClass = 'asp-hard'; const s1 = getSymbol(a.planet1); const s2 = getSymbol(a.planet2);
                        return `<div class="asp-item" onclick="onListClick('${a.planet1}')"><div class="asp-obj"><span class="inline-symbol">${s1}</span>${a.planet1_ko}</div><div class="asp-tag ${tagClass}">${a.type}</div><div class="asp-obj right"><span class="inline-symbol">${s2}</span>${a.planet2_ko}</div></div>`;
                    }).join('');
                }

            } catch (err) { alert("Error: " + err.message); } finally { btn.textContent = "分析 (ANALYZE)"; btn.disabled = false; }
        });
    </script>
</body>

</html>